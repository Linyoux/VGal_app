<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏存档</title>
    <!-- 链接到统一的主题样式表 -->
    <link rel="stylesheet" href="theme.css">
    <style>
        /* 存档界面特定的样式 */
        body {
            background-color: var(--bg-main);
            background-image: 
                radial-gradient(circle at 10% 20%, var(--save-view-accent) 0%, transparent 40%),
                radial-gradient(circle at 80% 90%, var(--save-view-accent) 0%, transparent 40%);
        }
        .page-title {
            color: var(--primary-color);
        }
        .card-grid {
            /* 横屏5列，竖屏2列 */
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
        @media (orientation: landscape) {
            .card-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        @media (orientation: portrait) {
            .card-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title">游戏存档</h1>
        <div class="card-grid" id="slots-grid">
            <!-- 存档槽将动态添加到这里 -->
        </div>
        <!-- 存档界面不需要分页和切换按钮，直接关闭即可 -->
    </div>

    <!-- 确认操作的模态弹窗 -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modal-header">确认覆盖存档</div>
            <div class="modal-body" id="modal-body">您确定要覆盖这个存档槽吗？此操作不可撤销。</div>
            <div class="modal-buttons">
                <button class="btn btn-danger" id="cancel-button">取消</button>
                <button class="btn btn-primary" id="confirm-button">确认</button>
            </div>
        </div>
    </div>

    <script>
        const SLOTS_PER_PAGE = 10;
        const TOTAL_PAGES = 10; // 总共10页，100个槽位
        let currentSlot = null;

        document.addEventListener('DOMContentLoaded', () => {
            renderSlots();
            setupModalListeners();
        });

        function renderSlots() {
            const grid = document.getElementById('slots-grid');
            grid.innerHTML = ''; // 清空现有内容

            const savedData = JSON.parse(VGAL.getSaveData() || '{}');

            for (let i = 1; i <= SLOTS_PER_PAGE * TOTAL_PAGES; i++) {
                const slotData = savedData[i];
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.slot = i;

                const img = document.createElement('img');
                img.className = 'card-image';
                
                const body = document.createElement('div');
                body.className = 'card-body';
                
                const title = document.createElement('h3');
                title.className = 'card-title';
                
                const text = document.createElement('p');
                text.className = 'card-text';

                if (slotData) {
                    // 有存档数据
                    img.src = slotData.bmpPath ? `data:image/png;base64,${slotData.bmpPath}` : 'about:blank';
                    title.textContent = `存档 ${i}`;
                    text.textContent = formatDateTime(slotData.saveTime);
                    card.onclick = () => showConfirmationModal(i, true); // 覆盖确认
                } else {
                    // 空存档槽
                    img.style.backgroundColor = '#000';
                    title.textContent = `存档 ${i}`;
                    text.textContent = '空存档';
                    card.onclick = () => saveGame(i); // 直接保存
                }
                
                body.appendChild(title);
                body.appendChild(text);
                card.appendChild(img);
                card.appendChild(body);
                grid.appendChild(card);
            }
        }

        function showConfirmationModal(slot, isOverwrite) {
            currentSlot = slot;
            const modal = document.getElementById('confirmationModal');
            document.getElementById('modal-header').textContent = isOverwrite ? `确认覆盖存档 ${slot}` : `确认保存至 ${slot}`;
            document.getElementById('modal-body').textContent = isOverwrite ? '您确定要覆盖这个存档槽吗？此操作不可撤销。' : '您确定要保存游戏吗？';
            modal.classList.add('show');
        }

        function setupModalListeners() {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('cancel-button').onclick = () => modal.classList.remove('show');
            document.getElementById('confirm-button').onclick = () => {
                modal.classList.remove('show');
                if (currentSlot !== null) {
                    saveGame(currentSlot);
                }
            };
        }

        function saveGame(slot) {
            const success = VGAL.SaveData(slot);
            if (success) {
                // 保存成功后，可以考虑关闭界面或刷新界面显示新截图
                VGAL.Close();
            } else {
                alert('存档失败！');
            }
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '未知时间';
            try {
                // Java LocalDateTime 格式: { "date": {...}, "time": {...} }
                const dt = dateTimeStr;
                const date = `${dt.date.year}-${String(dt.date.month).padStart(2, '0')}-${String(dt.date.day).padStart(2, '0')}`;
                const time = `${String(dt.time.hour).padStart(2, '0')}:${String(dt.time.minute).padStart(2, '0')}`;
                return `${date} ${time}`;
            } catch (e) {
                console.error("Error parsing date:", e);
                return dateTimeStr; // 解析失败则返回原始字符串
            }
        }
    </script>
</body>
</html>
