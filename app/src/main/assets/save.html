<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏存档</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        body {
            background-color: var(--bg-main);
            background-image: 
                radial-gradient(circle at 10% 20%, var(--save-view-accent) 0%, transparent 40%),
                radial-gradient(circle at 80% 90%, var(--save-view-accent) 0%, transparent 40%);
        }
        .page-title { color: var(--primary-color); }
        .card-grid {
            grid-template-columns: repeat(5, 1fr);
            min-height: 400px; /* 防止切换页面时高度塌陷 */
        }
        @media (orientation: portrait) {
            .card-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title">游戏存档</h1>
        <div id="loading-indicator" style="text-align: center; padding: 40px; display: none;">正在加载...</div>
        <div class="card-grid" id="slots-grid">
            <!-- 存档槽将动态添加到这里 -->
        </div>
        <div class="pagination" id="pagination">
            <button class="btn btn-primary" id="prev-button" disabled>上一页</button>
            <span class="page-info" id="page-info">第 1 / 10 页</span>
            <button class="btn btn-primary" id="next-button">下一页</button>
        </div>
    </div>

    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modal-header">确认覆盖存档</div>
            <div class="modal-body" id="modal-body">您确定要覆盖这个存档槽吗？此操作不可撤销。</div>
            <div class="modal-buttons">
                <button class="btn btn-danger" id="cancel-button">取消</button>
                <button class="btn btn-primary" id="confirm-button">确认</button>
            </div>
        </div>
    </div>

    <script>
        const SLOTS_PER_PAGE = 10;
        const TOTAL_PAGES = 10;
        let currentPage = 1;
        let currentSlot = null;
        let allSavedData = {};

        document.addEventListener('DOMContentLoaded', () => {
            fetchDataAndRender();
            setupPaginationListeners();
            setupModalListeners();
        });

        function fetchDataAndRender() {
            const grid = document.getElementById('slots-grid');
            const loading = document.getElementById('loading-indicator');
            grid.style.display = 'none';
            loading.style.display = 'block';

            setTimeout(() => {
                try {
                    allSavedData = JSON.parse(VGAL.getSaveData() || '{}');
                    renderSlotsForPage(currentPage);
                } catch(e) {
                    console.error("Failed to get save data:", e);
                    grid.innerHTML = `<p style="color: var(--danger-color);">读取存档数据失败。</p>`;
                } finally {
                    grid.style.display = 'grid';
                    loading.style.display = 'none';
                }
            }, 50); // 短暂延迟以显示加载动画
        }

        function renderSlotsForPage(page) {
            const grid = document.getElementById('slots-grid');
            grid.innerHTML = '';

            const startSlot = (page - 1) * SLOTS_PER_PAGE + 1;
            const endSlot = startSlot + SLOTS_PER_PAGE - 1;

            for (let i = startSlot; i <= endSlot; i++) {
                const slotData = allSavedData[i];
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.slot = i;

                const img = document.createElement('img');
                img.className = 'card-image';
                
                const body = document.createElement('div');
                body.className = 'card-body';
                
                const title = document.createElement('h3');
                title.className = 'card-title';
                
                const text = document.createElement('p');
                text.className = 'card-text';

                if (slotData) {
                    img.src = slotData.bmpPath ? `data:image/png;base64,${slotData.bmpPath}` : 'about:blank';
                    title.textContent = `存档 ${i}`;
                    text.textContent = formatDateTime(slotData.saveTime);
                    card.onclick = () => showConfirmationModal(i, true);
                } else {
                    img.style.backgroundColor = '#000';
                    title.textContent = `存档 ${i}`;
                    text.textContent = '空存档';
                    card.onclick = () => saveGame(i);
                }
                
                body.appendChild(title);
                body.appendChild(text);
                card.appendChild(img);
                card.appendChild(body);
                grid.appendChild(card);
            }
            updatePaginationUI();
        }

        function setupPaginationListeners() {
            document.getElementById('prev-button').onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderSlotsForPage(currentPage);
                }
            };
            document.getElementById('next-button').onclick = () => {
                if (currentPage < TOTAL_PAGES) {
                    currentPage++;
                    renderSlotsForPage(currentPage);
                }
            };
        }

        function updatePaginationUI() {
            document.getElementById('page-info').textContent = `第 ${currentPage} / ${TOTAL_PAGES} 页`;
            document.getElementById('prev-button').disabled = currentPage === 1;
            document.getElementById('next-button').disabled = currentPage === TOTAL_PAGES;
        }

        function showConfirmationModal(slot, isOverwrite) {
            currentSlot = slot;
            const modal = document.getElementById('confirmationModal');
            document.getElementById('modal-header').textContent = `确认覆盖存档 ${slot}`;
            document.getElementById('modal-body').textContent = '您确定要覆盖这个存档槽吗？此操作不可撤销。';
            modal.classList.add('show');
        }

        function setupModalListeners() {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('cancel-button').onclick = () => modal.classList.remove('show');
            document.getElementById('confirm-button').onclick = () => {
                modal.classList.remove('show');
                if (currentSlot !== null) {
                    saveGame(currentSlot);
                }
            };
        }

        function saveGame(slot) {
            const success = VGAL.SaveData(slot);
            if (success) {
                VGAL.Close();
            } else {
                alert('存档失败！');
            }
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '未知时间';
            try {
                const dt = dateTimeStr;
                const date = `${dt.date.year}-${String(dt.date.month).padStart(2, '0')}-${String(dt.date.day).padStart(2, '0')}`;
                const time = `${String(dt.time.hour).padStart(2, '0')}:${String(dt.time.minute).padStart(2, '0')}`;
                return `${date} ${time}`;
            } catch (e) {
                return "日期解析错误";
            }
        }
    </script>
</body>
</html>
